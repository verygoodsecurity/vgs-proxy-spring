# VGS Samples â€“ Card Issuance

This sample is intended to demonstrate how a payment card issuance application
can be implemented using VGS to secure sensitive data in transit and at rest.

## Requirements

- Make sure [jq](https://stedolan.github.io/jq/) is installed on your system.

## Running the application

### Sign up for a Marqeta account

[Marqeta](https://www.marqeta.com/platform) is a card issuing and payment
processing platform. It provides its customers with a shared API sandbox in
order to acquaint them with the Marqeta API.

We'll be using the API sandbox to simulate virtual card issuance. To get access
to it, sign up for a Marqeta account at https://www.marqeta.com/users/sign_up.

### Marqeta API keys

Once you're signed in to Marqeta, search your profile for API keys and set the
following environment variables with the corresponding values:

```bash
export MARQETA_APPLICATION_TOKEN="<Application Token>"
export MARQETA_MASTER_ACCESS_TOKEN="<Master Access Token>"
```

If you're having difficulties finding your API keys, please refer to
[this paragraph](https://www.marqeta.com/api/guides/WIlA2isAAMkAsk6F/quick-start---marqeta-api#step_____get_access)
of the Marqeta Quick Start guide.

![Marqeta API Keys](img/marqeta_api_keys.png)

### Create a card product

To issue a card, Marqeta requires a [card product](https://www.marqeta.com/api/docs/VhyptRwAAB8A_VeO/card-products).
Basically, it's a template that specifies various card properties.

Since our application will be issuing virtual cards, we need an appropriate card
product. Create one by executing the following command:

```bash
export MARQETA_CARD_PRODUCT_TOKEN=\
$(curl -X POST \
    https://shared-sandbox-api.marqeta.com/v3/cardproducts \
    --user "$MARQETA_APPLICATION_TOKEN:$MARQETA_MASTER_ACCESS_TOKEN" \
    -H 'Content-Type: application/json' \
    --data '{
        "name": "VGS Samples :: Card Issuance",
        "start_date": "2018-08-06T10:30:00Z",
        "config": {
            "fulfillment": {
                "payment_instrument": "VIRTUAL_PAN"
            },
            "card_life_cycle": {
                "activate_upon_issue": "true"
            }
        }
    }' -s | jq -r '.token')
```

Apart from creating the required resource, it will also set the
`MARQETA_CARD_PRODUCT_TOKEN` environment variable with the unique token
generated by Marqeta for the card product.

### ngrok tunnel

Next, fire up [ngrok](https://ngrok.com/) to expose the local port the
application will be listening on to the Internet:

```bash
./ngrok http 8080
```

This step is done in advance prior to running the application since the
forwarding URL from the ngrok output is used for routes configuration on the VGS
dashboard.

![ngrok Forwarding URL](img/ngrok_forwarding_url.png)

### Create a secure vault

In VGS, sensitive data is stored and managed inside so-called vaults.

Go to the VGS dashboard at https://dashboard.verygoodsecurity.com/ in order to
create a new vault for use with the application. Please refer to our
[Getting Started](https://www.verygoodsecurity.com/docs/getting-started) guide
if you're unfamiliar with the process.

### Configure the VGS proxies

After creating a vault, proceed to the Routes section of it and configure the
routes as described below.

![Routes Section](img/routes_section.png)

#### Inbound Route

Upstream Host: the forwarding URL previously assigned by ngrok (e.g.,
`https://6ca7be3b.ngrok.io`)

<table>
    <caption>Filters</caption>
    <thead>
        <th>HTTP Method</th>
        <th>PathInfo</th>
        <th>Phase</th>
        <th>Operation</th>
        <th>Fields (Json)</th>
    </thead>
    <tbody>
        <tr>
            <td>POST</td>
            <td>/cards</td>
            <td>On request</td>
            <td>REDACT</td>
            <td>
                <ul>
                    <li>$.first_name</li>
                    <li>$.last_name</li>
                    <li>$.email</li>
                    <li>$.ssn</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>POST</td>
            <td>/cards</td>
            <td>On response</td>
            <td>REVEAL</td>
            <td>
                <ul>
                    <li>$.token</li>
                    <li>$.user_token</li>
                    <li>$.pan</li>
                    <li>$.cvv_number</li>
                </ul>
            </td>
        </tr>
    </tbody>
</table>

#### Outbound Route

Upstream Host: `shared-sandbox-api\.marqeta\.com`

**NOTE:** Unlike Upstream Host in Inbound Route configuration, this one is
expected to be a [regular expression](https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html)
(hence the `\` characters).

<table>
    <caption>Filters</caption>
    <thead>
        <th>HTTP Method</th>
        <th>PathInfo</th>
        <th>Phase</th>
        <th>Operation</th>
        <th>Fields (Json)</th>
    </thead>
    <tbody>
        <tr>
            <td>POST</td>
            <td>/v3/users</td>
            <td>On request</td>
            <td>REVEAL</td>
            <td>
                <ul>
                    <li>$.token</li>
                    <li>$.first_name</li>
                    <li>$.last_name</li>
                    <li>$.email</li>
                    <li>$.ssn</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>POST</td>
            <td>/v3/users</td>
            <td>On response</td>
            <td>REDACT</td>
            <td>
                <ul>
                    <li>$.token</li>
                    <li>$.first_name</li>
                    <li>$.last_name</li>
                    <li>$.email</li>
                    <li>$.ssn</li>
                    <li>$.deposit_account.token</li>
                    <li>$.deposit_account.account_number</li>
                    <li>$.deposit_account.routing_number</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>POST</td>
            <td>/v3/cards</td>
            <td>On request</td>
            <td>REVEAL</td>
            <td>
                <ul>
                    <li>$.user_token</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>POST</td>
            <td>/v3/cards</td>
            <td>On response</td>
            <td>REDACT</td>
            <td>
                <ul>
                    <li>$.token</li>
                    <li>$.user_token</li>
                    <li>$.pan</li>
                    <li>$.cvv_number</li>
                </ul>
            </td>
        </tr>
    </tbody>
</table>

### Set route URLs

Lastly, for the routes configured in the previous step to take effect, requests
to and from the application must pass through the VGS reverse and forward
proxies, respectively.

On the vault page, look for the Vault URLs link: ![Vault URLs](img/vault_urls.png)

To set the Inbound Route URL, execute the following command:

```bash
sed -i '' 's|INBOUND_ROUTE_URL|<Inbound Route URL>|g' src/main/resources/static/scripts/index.js
```

To set the Outbound Route URL, execute the following command:

```bash
export VGS_PROXY_URL="<Outbound Route URL>"
```

### Start the application

```bash
mvn clean package spring-boot:run -DskipTests
```
